<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Chinese tones training</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<body class="container">

<h1 class="mt-3">Chinese tones training</h1>

<p class="mt-3 mb-3">
	<input id="btn-playrandom" type="button" class="btn btn-primary mt-5 me-2" value="Play random">
	<input id="btn-repeat" type="button" class="btn btn-secondary mt-5 me-2" value="Repeat last">	
	<input id="btn-answer" type="button" class="btn btn-success mt-5 me-2" data-bs-toggle="collapse" data-bs-target="#answer" aria-expanded="false" aria-controls="answer" value="Show answer">	
	<input id="btn-showaudio" type="button" class="btn btn-info mt-5 me-2" value="Show audio">
</p>

<div id="answer" class="collapse mb-3">Start text first.</div>

<div id="audiolist" class="collapse"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" type="text/javascript" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

<script>
"use strict";

let lastPlayed = null;

let mp3FilesPrefix = "tone_perfect/mp3/";
let mp3List = {
	"ma": [
		"ma1_MV1_MP3.mp3", "ma2_MV1_MP3.mp3", "ma3_MV1_MP3.mp3", "ma4_MV1_MP3.mp3"
	],
	"a": [
		"a1_MV1_MP3.mp3", "a2_MV1_MP3.mp3", "a3_MV1_MP3.mp3", "a4_MV1_MP3.mp3"
	],
	"zuo": [
		"zuo1_MV1_MP3.mp3", "zuo2_MV1_MP3.mp3", "zuo3_MV1_MP3.mp3", "zuo4_MV1_MP3.mp3"
	]
};

// https://tone.lib.msu.edu/tone/6386/datastream/PROXY_MP3

let pinyins;


function generateAudios(mp3FilesPrefix, mp3List) {
	let audioListEl = document.getElementById("audiolist");


	for (let syllable in mp3List) {
		//console.log(syllable, mp3List[syllable]);

		let tonesDiv = document.createElement("div");
		tonesDiv.id = syllable;

		for (let tone in mp3List[syllable]) {
			//console.log(tone, mp3List[syllable][tone]);

			let mp3file = mp3List[syllable][tone];
			let audioEl = document.createElement("audio");

			audioEl.src = mp3FilesPrefix + mp3file;
			audioEl.dataset.name = syllable + " " + String(Number(tone)+1);
			audioEl.dataset.syllable = syllable;
			audioEl.dataset.tone = Number(tone)+1;
			audioEl.dataset.filename = mp3file;
			audioEl.dataset.description = syllable + " " + String(Number(tone)+1) + " (" + mp3file + ")";
			audioEl.controls = true;

			tonesDiv.appendChild(audioEl);
		}

		audioListEl.appendChild(tonesDiv);

	}
}

function loadData() {
	fetch('pinyins.json')
		.then(response => response.json())
		.then(data => {
			pinyins = data;
			//console.log(data)
		});
}


// pinyin = string
// tone = 1, 2, 3 or 4
// voice = FV1, FV2, FV3, FV4, MV1, MV2 or MV3
// Eg. playVoice("a", 1, "mv1") = play a1 with MV1 = a1_MV1_MP3.mp3
function playVoice(pinyin, tone, voice) {
	if (pinyin && tone && voice) {
		pinyin = String(pinyin).toLowerCase();
		tone = parseInt(tone);
		voice = String(voice).toUpperCase();

		if (pinyin.match(/^[a-Z]{1,6}$/) && voice.match(/^[MF]V[1-3]$/) && tone >= 1 && tone <= 4 ) {
			let filename = pinyin + String(tone) + "_" + voice + "_MP3.mp3";
			console.debug("Play", filename);
			playFile(filename);
		}
	}
}

// Eg. playFile("a1_FV1_MP3.mp3"), playFile("zhuang1_FV2_MP3.mp3")
function playFile(filename) {
	if (filename && String(filename)) {
		filename = String(filename);

		if (filename.match(/^[a-z]{1,6}[1-4]_[MF]V[1-3]_MP3\.mp3$/)) {
			let url = "tone_perfect/mp3/" + filename;
			playURL(url);
		}
	}
}

// Eg. playId(1584)
function playId(id) {
	if (id && parseInt(id)) {
		id = parseInt(id);
		if (id > 1000 && id < 12000) {
			const url = `https://tone.lib.msu.edu/tone/${id}/datastream/PROXY_MP3`;
			console.debug("Play", id);
			playURL(url);
		}
	}
}

// Eg. playURL("https://tone.lib.msu.edu/tone/1584/datastream/PROXY_MP3")
function playURL(url) {
	if (url) {
		console.debug("Play", url);
		let audio = new Audio(url);
		audio.play();
	}
}

function initUI() {
	document.getElementById("btn-playrandom").onclick = function(event) {
		setTimeout(playRandom, 10);
		return false;
	}

	document.getElementById("btn-repeat").onclick = function(event) {
		setTimeout(playLastAgain, 10);
		return false;
	}

	document.getElementById("btn-showaudio").onclick = function(event) {
		document.getElementById("audiolist").classList.toggle("show");
		return false;
	}
}

loadData();
//generateAudios(mp3FilesPrefix, mp3List);
initUI();

function playRandom() {

	document.getElementById("answer").classList.remove("show");

	let audioList = document.querySelectorAll("audio");
	let rnd = Math.floor(Math.random()*audioList.length); // random index [0..audioList.length-1]

	let audio = document.querySelectorAll("audio")[rnd];
	audio.play();

	lastPlayed = rnd;

	let audioURL = audio.currentSrc;
	let audioName = audio.dataset.name;
	let audioFilename = audio.dataset.filename

	let answer;

	if (audioName && audioFilename) {
		answer = "<b>" + audioName + "</b> - " + audioFilename;
	}
	else {
		answer = audioURL;
	}

	document.getElementById("answer").innerHTML = answer;
}

function playLastAgain() {

	if (lastPlayed !== null) {
		let audio = document.querySelectorAll("audio")[lastPlayed];

		if (audio) {
			audio.play();
		}
	}

}

</script>
